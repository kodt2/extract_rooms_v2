# extract_rooms_v2

Сервис для подбора свободных аудиторий по расписанию RUZ, сохранения урезанного расписания на диск и заготовкой для Telegram-бота.

## Что делает
- Загружает расписание по `BASE_URL = https://portal.unn.ru/ruzapi/schedule/building/{building_oid}`.
- Отфильтровывает только разрешённые аудитории (из конфига).
- Загружает данные в диапазоне: от (сегодня - N дней) до (сегодня + M месяцев), значения берутся из конфига.
- Сохраняет очищенное расписание в файл (`schedule_cache_path`) и использует его при обработке запросов.
- Обрабатывает партию запросов и не допускает пересечения по одной аудитории внутри этой партии.
- Для отсутствующего дня возвращает `no day in shulde`.
- При отсутствии свободной аудитории возвращает `no free room`.
- Поддерживает второй режим: формирование текстового payload для будущего PDF.
- Содержит заготовку для Telegram-бота с фоновым обновлением кеша в 04:00 и 16:00 (MSK).

## Входной формат запроса
Одна строка на запрос:

```text
[Имя Фамилия Цель дд.мм чч:мм чч:мм тип_аудитории]
```

Поддерживаемые типы аудиторий:
- `any`, `any2`, `any6`
- `big`, `big2`, `big6`
- конкретный номер аудитории (например `305`)

## Конфиг
Скопируйте `config.example.json` в `config.json` и настройте:
- `buildings` — соответствие номер корпуса -> oid
- `schedule_window_days_before` — сколько дней вычесть от текущей даты для начала диапазона
- `schedule_window_months_after` — сколько месяцев добавить к текущей дате для конца диапазона
- `schedule_range_from_param` / `schedule_range_to_param` — имена query-параметров диапазона дат для API
- `schedule_range_date_format` — формат даты для query-параметров (например `%Y-%m-%d`)
- `schedule_cache_path` — куда сохранять урезанное расписание на диске
- `refresh_poll_seconds` — частота проверки времени обновления в фоне
- `allowed_rooms` — аудитории, в которых разрешён поиск
- `big_rooms` — аудитории большого типа
- `contact_fields` — поля для режима генерации отчёта (телефон, ФИО и т.д.)

## Запуск
Ручное обновление и сохранение кеша:

```bash
python -m app.main --config config.json --mode refresh
```

Команда выводит `Days loaded` (это количество дат, где после фильтрации остались пары), и диагностику пропусков (`not_allowed`, `out_of_range`, и т.д.).
Если API плохо реагирует на формат дат из конфига, клиент автоматически пробует fallback-форматы (`%Y.%m.%d`, `%Y-%m-%d`, `%d.%m.%Y`) и берет самый полный ответ по диапазону.

Подбор аудиторий:

```bash
python -m app.main --config config.json --input requests.txt --mode allocate
```

Режим генерации отчёта:

```bash
python -m app.main --config config.json --input requests.txt --mode pdf --output output/report.txt
```

Заготовка запуска Telegram-бота:

```bash
python -m app.main --config config.json --mode bot
```

## Обновление расписания
- `RoomService.refresh_schedule_cache()` загружает и сразу сохраняет очищенные данные в `schedule_cache_path`.
- `ScheduleRefresher` предназначен для фона (например, внутри Telegram-бота) и вызывает обновление в 04:00 и 16:00 по Москве.
